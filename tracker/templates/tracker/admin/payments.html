{% extends 'tracker/admin/base.html' %}
{% load tracker_extras %}

{% block title %}Payments - Admin Panel{% endblock %}
{% block page_title %}Payment Management{% endblock %}
{% block page_subtitle %}Review and verify payment proofs from customers{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Pending Payments -->
    <div class="bg-white rounded-xl shadow-sm border">
        <div class="border-b border-gray-200 px-6 py-4">
            <h3 class="text-lg font-bold text-dark flex items-center">
                <i class="fas fa-clock text-warning mr-2"></i>
                Pending Payment Verification
                <span class="ml-3 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
                    {{ pending_proofs.count }} pending
                </span>
            </h3>
        </div>
        
        <div class="p-6">
            {% if pending_proofs %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for proof in pending_proofs %}
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div class="font-semibold text-dark">{{ proof.shipment.tracking_number }}</div>
                        <div class="text-xs text-gray-500">{{ proof.date_uploaded|date:"M d, Y H:i" }}</div>
                    </div>
                    
                    <!-- Payment Proof Image -->
                    <div class="mb-3">
                        <img src="{{ proof.image.url }}" 
                             alt="Payment Proof" 
                             class="w-full h-32 object-cover rounded-lg border cursor-pointer"
                             onclick="openImageModal('{{ proof.image.url }}')">
                    </div>
                    
                    <!-- Shipment Details -->
                    <div class="space-y-2 text-sm mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Sender:</span>
                            <span class="font-medium">{{ proof.shipment.sender_name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Receiver:</span>
                            <span class="font-medium">{{ proof.shipment.receiver_name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Amount:</span>
                            <span class="font-semibold text-green-600">${{ proof.shipment.total_cost }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Method:</span>
                            <span class="font-medium">{{ proof.shipment.get_payment_method_display }}</span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex space-x-2">
                        <a href="{% url 'verify_payment' proof.id %}" 
                           class="flex-1 bg-accent hover:bg-green-700 text-white py-2 px-3 rounded text-sm text-center transition-colors">
                            <i class="fas fa-check mr-1"></i>Verify
                        </a>
                        <a href="{% url 'reject_payment' proof.id %}" 
                           class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded text-sm text-center transition-colors">
                            <i class="fas fa-times mr-1"></i>Reject
                        </a>
                        <a href="/track/?tracking_number={{ proof.shipment.tracking_number }}" 
                           target="_blank"
                           class="flex-1 bg-primary hover:bg-secondary text-white py-2 px-3 rounded text-sm text-center transition-colors">
                            <i class="fas fa-eye mr-1"></i>View
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
                <div class="text-lg font-medium text-gray-600">No pending payments</div>
                <p class="text-sm text-gray-500 mt-2">All payment proofs have been verified</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recently Verified Payments -->
    <div class="bg-white rounded-xl shadow-sm border">
        <div class="border-b border-gray-200 px-6 py-4">
            <h3 class="text-lg font-bold text-dark flex items-center">
                <i class="fas fa-check-circle text-accent mr-2"></i>
                Recently Verified Payments
            </h3>
        </div>
        
        <div class="p-6">
            {% if verified_proofs %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Tracking #</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Amount</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Method</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Verified Date</th>
                            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proof in verified_proofs %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4">
                                <div class="font-mono text-sm font-semibold">{{ proof.shipment.tracking_number }}</div>
                            </td>
                            <td class="py-3 px-4">
                                <span class="font-semibold text-green-600">${{ proof.shipment.total_cost }}</span>
                            </td>
                            <td class="py-3 px-4">
                                <span class="text-sm">{{ proof.shipment.get_payment_method_display }}</span>
                            </td>
                            <td class="py-3 px-4 text-sm text-gray-600">
                                {{ proof.date_uploaded|date:"M d, Y H:i" }}
                            </td>
                            <td class="py-3 px-4">
                                <div class="flex space-x-2">
                                    <a href="{{ proof.image.url }}" 
                                       target="_blank"
                                       class="text-primary hover:text-secondary transition-colors"
                                       title="View Proof">
                                        <i class="fas fa-image"></i>
                                    </a>
                                    <a href="/track/?tracking_number={{ proof.shipment.tracking_number }}" 
                                       target="_blank"
                                       class="text-green-600 hover:text-green-800 transition-colors"
                                       title="View Shipment">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-history text-3xl mb-3"></i>
                <div>No verified payments yet</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
    <div class="relative max-w-4xl max-h-full">
        <button onclick="closeImageModal()" class="absolute -top-12 right-0 text-white text-2xl hover:text-gray-300 transition-colors">
            <i class="fas fa-times"></i>
        </button>
        <img id="modalImage" src="" alt="Payment Proof" class="max-w-full max-h-full rounded-lg">
    </div>
</div>

<script>
    function openImageModal(src) {
        document.getElementById('modalImage').src = src;
        document.getElementById('imageModal').classList.remove('hidden');
        document.getElementById('imageModal').classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
        document.getElementById('imageModal').classList.add('hidden');
        document.getElementById('imageModal').classList.remove('flex');
        document.body.style.overflow = 'auto';
    }
</script>
{% endblock %}