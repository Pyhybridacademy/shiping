{% extends 'tracker/admin/base.html' %}
{% load tracker_extras %}

{% block title %}Dashboard - Admin Panel{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}
{% block page_subtitle %}Welcome back, {{ request.user.username }}! Here's what's happening with your shipments.{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
        <div class="stat-card rounded-xl p-4 md:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Shipments</p>
                    <h3 class="text-2xl md:text-3xl font-bold text-dark mt-2">{{ total_shipments }}</h3>
                </div>
                <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-box text-primary text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-green-600 font-medium">{{ weekly_shipments }} this week</span>
            </div>
        </div>

        <div class="stat-card rounded-xl p-4 md:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Pending Shipments</p>
                    <h3 class="text-2xl md:text-3xl font-bold text-dark mt-2">{{ pending_shipments }}</h3>
                </div>
                <div class="w-10 h-10 md:w-12 md:h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-warning text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <span class="text-yellow-600 text-sm font-medium">Need attention</span>
            </div>
        </div>

        <div class="stat-card rounded-xl p-4 md:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Pending Payments</p>
                    <h3 class="text-2xl md:text-3xl font-bold text-dark mt-2">{{ pending_payments }}</h3>
                </div>
                <div class="w-10 h-10 md:w-12 md:h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-credit-card text-orange-600 text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-4">
                <a href="{% url 'admin_payments' %}" class="text-primary text-sm font-medium hover:underline">Review payments →</a>
            </div>
        </div>

        <div class="stat-card rounded-xl p-4 md:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Revenue</p>
                    <h3 class="text-2xl md:text-3xl font-bold text-dark mt-2">${{ total_revenue }}</h3>
                </div>
                <div class="w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-dollar-sign text-accent text-lg md:text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-sm">
                <span class="text-green-600 font-medium">${{ weekly_revenue }} this week</span>
            </div>
        </div>
    </div>

    <!-- Charts and Recent Activity -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Status Distribution -->
        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border p-4 md:p-6">
            <h3 class="text-lg font-bold text-dark mb-4">Shipment Status Distribution</h3>
            <div class="h-64">
                <canvas id="statusChart"></canvas>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-sm border p-4 md:p-6">
            <h3 class="text-lg font-bold text-dark mb-4">Quick Actions</h3>
            <div class="space-y-3">
                <a href="{% url 'admin_create_shipment' %}" class="w-full bg-primary hover:bg-secondary text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-300">
                    <i class="fas fa-plus"></i>
                    <span>Create New Shipment</span>
                </a>
                <a href="{% url 'admin_payments' %}" class="w-full bg-accent hover:bg-green-700 text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-300">
                    <i class="fas fa-credit-card"></i>
                    <span>Manage Payments</span>
                </a>
                <a href="{% url 'admin_stats' %}" class="w-full bg-dark hover:bg-gray-800 text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-all duration-300">
                    <i class="fas fa-chart-bar"></i>
                    <span>View Analytics</span>
                </a>
            </div>

            <!-- Status Summary -->
            <div class="mt-6 pt-6 border-t border-gray-200">
                <h4 class="font-semibold text-dark mb-3">Status Summary</h4>
                <div class="space-y-2">
                    {% for stat in status_stats %}
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600">{{ stat.status|title }}</span>
                        <span class="font-semibold">{{ stat.count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Shipments -->
    <div class="bg-white rounded-xl shadow-sm border p-4 md:p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold text-dark">Recent Shipments</h3>
            <a href="{% url 'admin_shipments' %}" class="text-primary hover:underline text-sm font-medium">View All →</a>
        </div>
        
        <div class="table-container">
            <table class="w-full min-w-max">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-2 md:px-4 text-sm font-semibold text-gray-600">Tracking #</th>
                        <th class="text-left py-3 px-2 md:px-4 text-sm font-semibold text-gray-600">Sender → Receiver</th>
                        <th class="text-left py-3 px-2 md:px-4 text-sm font-semibold text-gray-600">Status</th>
                        <th class="text-left py-3 px-2 md:px-4 text-sm font-semibold text-gray-600">Payment</th>
                        <th class="text-left py-3 px-2 md:px-4 text-sm font-semibold text-gray-600">Last Updated</th>
                        <th class="text-left py-3 px-2 md:px-4 text-sm font-semibold text-gray-600">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shipment in recent_shipments %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-2 md:px-4">
                            <div class="font-mono text-sm font-semibold">{{ shipment.tracking_number }}</div>
                        </td>
                        <td class="py-3 px-2 md:px-4">
                            <div class="text-sm">
                                <div class="font-medium">{{ shipment.sender_name }}</div>
                                <div class="text-gray-500 text-xs">→ {{ shipment.receiver_name }}</div>
                            </div>
                        </td>
                        <td class="py-3 px-2 md:px-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {{ shipment.status|status_badge_class }}">
                                {{ shipment.get_status_display }}
                            </span>
                        </td>
                        <td class="py-3 px-2 md:px-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {{ shipment.payment_status|payment_status_class }}">
                                {{ shipment.get_payment_status_display }}
                            </span>
                        </td>
                        <td class="py-3 px-2 md:px-4 text-sm text-gray-600">
                            {{ shipment.last_updated|date:"M d, Y" }}
                        </td>
                        <td class="py-3 px-2 md:px-4">
                            <div class="flex space-x-2">
                                <a href="{% url 'admin_edit_shipment' shipment.id %}" class="text-primary hover:text-secondary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="/track/?tracking_number={{ shipment.tracking_number }}" target="_blank" class="text-green-600 hover:text-green-800" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="py-4 px-4 text-center text-gray-500">
                            No shipments found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Status Distribution Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: [
                {% for stat in status_stats %}
                '{{ stat.status|title }}',
                {% endfor %}
            ],
            datasets: [{
                data: [
                    {% for stat in status_stats %}
                    {{ stat.count }},
                    {% endfor %}
                ],
                backgroundColor: [
                    '#6b7280', // pending - gray
                    '#3b82f6', // picked - blue
                    '#f59e0b', // on_hold - yellow
                    '#eab308', // on_way - yellow
                    '#ef4444', // custom_hold - red
                    '#10b981', // delivered - green
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
</script>
{% endblock %}