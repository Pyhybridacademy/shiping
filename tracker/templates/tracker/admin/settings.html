{% extends 'tracker/admin/base.html' %}

{% block title %}Settings - Admin Panel{% endblock %}
{% block page_title %}System Settings{% endblock %}
{% block page_subtitle %}Configure PDF stamps, site information, and system preferences{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Site Configuration Section -->
    <div class="bg-white rounded-xl shadow-sm border p-6">
        <h3 class="text-lg font-bold text-dark mb-4 flex items-center">
            <i class="fas fa-cog text-primary mr-2"></i>
            Site Configuration
        </h3>
        
        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} p-3 rounded-lg mb-2 {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200{% else %}bg-blue-100 text-blue-800 border border-blue-200{% endif %}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        {% if message.tags == 'success' %}
                        <i class="fas fa-check-circle mr-3"></i>
                        {% elif message.tags == 'error' %}
                        <i class="fas fa-exclamation-circle mr-3"></i>
                        {% else %}
                        <i class="fas fa-info-circle mr-3"></i>
                        {% endif %}
                        {{ message }}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Basic Information -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-dark border-b pb-2">Basic Information</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Site Name *</label>
                        <input type="text" name="site_name" value="{{ site_settings.site_name }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="GlobalTrack Pro" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Name *</label>
                        <input type="text" name="company_name" value="{{ site_settings.company_name }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="GlobalTrack Pro" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email *</label>
                        <input type="email" name="contact_email" value="{{ site_settings.contact_email }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="support@globaltrackpro.com" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Phone *</label>
                        <input type="text" name="contact_phone" value="{{ site_settings.contact_phone }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="+1 (555) 123-4567" required>
                    </div>
                </div>
                
                <!-- Company Details -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-dark border-b pb-2">Company Details</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Address</label>
                        <textarea name="company_address" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                                  placeholder="Global Headquarters">{{ site_settings.company_address }}</textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Website URL</label>
                        <input type="url" name="website_url" value="{{ site_settings.website_url }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="https://globaltrackpro.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Logo</label>
                        <input type="file" name="company_logo" accept="image/*" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Recommended: 200x60px PNG with transparent background</p>
                        
                        {% if site_settings.company_logo %}
                        <div class="mt-2">
                            <span class="text-sm text-gray-600">Current Logo:</span>
                            <img src="{{ site_settings.company_logo.url }}" alt="Company Logo" class="w-32 h-10 object-contain border rounded mt-1">
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- PDF Settings -->
            <div class="mt-6 pt-6 border-t">
                <h4 class="font-semibold text-dark mb-4">PDF Settings</h4>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PDF Header Title</label>
                        <input type="text" name="pdf_header_title" value="{{ site_settings.pdf_header_title }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="SHIPMENT TRACKING REPORT">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PDF Footer Text</label>
                        <input type="text" name="pdf_footer_text" value="{{ site_settings.pdf_footer_text }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="Generated by GlobalTrack Pro">
                    </div>
                </div>
            </div>
            
            <!-- Social Media Links -->
            <div class="mt-6 pt-6 border-t">
                <h4 class="font-semibold text-dark mb-4">Social Media Links (Optional)</h4>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Facebook URL</label>
                        <input type="url" name="facebook_url" value="{{ site_settings.facebook_url|default:'' }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="https://facebook.com/yourpage">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Twitter URL</label>
                        <input type="url" name="twitter_url" value="{{ site_settings.twitter_url|default:'' }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="https://twitter.com/yourhandle">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn URL</label>
                        <input type="url" name="linkedin_url" value="{{ site_settings.linkedin_url|default:'' }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                               placeholder="https://linkedin.com/company/yourcompany">
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end mt-6 pt-6 border-t">
                <button type="submit" name="update_site_settings" 
                        class="bg-primary hover:bg-secondary text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                    <i class="fas fa-save mr-2"></i>Save Site Settings
                </button>
            </div>
        </form>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- PDF Stamps Management -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Current Stamps -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="text-lg font-bold text-dark mb-4 flex items-center">
                    <i class="fas fa-stamp text-primary mr-2"></i>
                    PDF Stamps & Signatures
                </h3>
                
                {% if stamps %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for stamp in stamps %}
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-gray-300 transition-colors">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-dark">{{ stamp.name }}</h4>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if stamp.is_active %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if stamp.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div class="text-center">
                                <div class="text-xs text-gray-600 mb-1">Stamp</div>
                                {% if stamp.stamp_image %}
                                <img src="{{ stamp.stamp_image.url }}" alt="Stamp" class="w-16 h-16 object-contain mx-auto border rounded">
                                {% else %}
                                <div class="w-16 h-16 border-2 border-dashed border-gray-300 rounded flex items-center justify-center mx-auto">
                                    <i class="fas fa-stamp text-gray-400"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-600 mb-1">Signature</div>
                                {% if stamp.signature_image %}
                                <img src="{{ stamp.signature_image.url }}" alt="Signature" class="w-16 h-8 object-contain mx-auto border rounded">
                                {% else %}
                                <div class="w-16 h-8 border-2 border-dashed border-gray-300 rounded flex items-center justify-center mx-auto">
                                    <i class="fas fa-signature text-gray-400"></i>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="flex space-x-2">
                            <!-- Edit Button -->
                            <form method="POST" class="flex-1">
                                {% csrf_token %}
                                <input type="hidden" name="stamp_id" value="{{ stamp.id }}">
                                <button type="submit" name="update_stamp" class="w-full bg-primary hover:bg-secondary text-white py-2 px-3 rounded text-sm transition-colors">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                            </form>
                            
                            <!-- Activate Button -->
                            {% if not stamp.is_active %}
                            <form method="POST" class="flex-1">
                                {% csrf_token %}
                                <input type="hidden" name="stamp_id" value="{{ stamp.id }}">
                                <button type="submit" name="activate_stamp" class="w-full bg-accent hover:bg-green-700 text-white py-2 px-3 rounded text-sm transition-colors">
                                    <i class="fas fa-check mr-1"></i>Activate
                                </button>
                            </form>
                            {% endif %}
                            
                            <!-- Delete Button -->
                            <form method="POST" class="flex-1" onsubmit="return confirmDelete('{{ stamp.name }}')">
                                {% csrf_token %}
                                <input type="hidden" name="stamp_id" value="{{ stamp.id }}">
                                <button type="submit" name="delete_stamp" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded text-sm transition-colors">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-stamp text-4xl mb-3"></i>
                    <div>No PDF stamps configured</div>
                    <p class="text-sm mt-2">Create your first stamp to use in PDF reports</p>
                </div>
                {% endif %}
            </div>

            <!-- Add/Edit Stamp Form -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="text-lg font-bold text-dark mb-4">
                    {% if editing_stamp %}Edit Stamp: {{ editing_stamp.name }}{% else %}Add New Stamp{% endif %}
                </h3>
                
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    {% if editing_stamp %}
                    <input type="hidden" name="stamp_id" value="{{ editing_stamp.id }}">
                    {% endif %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stamp Name *</label>
                                <input type="text" name="name" value="{% if editing_stamp %}{{ editing_stamp.name }}{% endif %}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                                       placeholder="Enter stamp name" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stamp Image</label>
                                <input type="file" name="stamp_image" accept="image/*" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Recommended: 150x150px PNG with transparent background</p>
                                
                                {% if editing_stamp and editing_stamp.stamp_image %}
                                <div class="mt-2">
                                    <span class="text-sm text-gray-600">Current:</span>
                                    <img src="{{ editing_stamp.stamp_image.url }}" alt="Current stamp" class="w-16 h-16 object-contain border rounded mt-1">
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Signature Image</label>
                                <input type="file" name="signature_image" accept="image/*" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                                <p class="text-xs text-gray-500 mt-1">Recommended: 200x50px PNG with transparent background</p>
                                
                                {% if editing_stamp and editing_stamp.signature_image %}
                                <div class="mt-2">
                                    <span class="text-sm text-gray-600">Current:</span>
                                    <img src="{{ editing_stamp.signature_image.url }}" alt="Current signature" class="w-32 h-12 object-contain border rounded mt-1">
                                </div>
                                {% endif %}
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" name="is_active" {% if editing_stamp and editing_stamp.is_active %}checked{% endif %} 
                                           class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                                    <span class="ml-2 text-sm text-gray-700">Active (will be used in PDF generation)</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1 ml-6">Activating this stamp will deactivate others</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-4 mt-6 pt-6 border-t">
                        {% if editing_stamp %}
                        <a href="{% url 'admin_settings' %}" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancel
                        </a>
                        {% endif %}
                        <button type="submit" name="{% if editing_stamp %}update_stamp{% else %}create_stamp{% endif %}" 
                                class="bg-accent hover:bg-green-700 text-white px-8 py-3 rounded-lg font-semibold transition-colors">
                            {% if editing_stamp %}Update Stamp{% else %}Create Stamp{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- System Information -->
        <div class="space-y-6">
            <!-- System Status -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="text-lg font-bold text-dark mb-4">System Status</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Shipments</span>
                        <span class="font-semibold">{{ total_shipments }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Active Stamps</span>
                        <span class="font-semibold">{{ active_stamps_count }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Pending Payments</span>
                        <span class="font-semibold">{{ pending_payments_count }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">System Version</span>
                        <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">v2.1.0</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-sm border p-6">
                <h3 class="text-lg font-bold text-dark mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <a href="{% url 'admin_shipments' %}" class="w-full bg-primary hover:bg-secondary text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors text-sm">
                        <i class="fas fa-box"></i>
                        <span>Manage Shipments</span>
                    </a>
                    <a href="{% url 'admin_payments' %}" class="w-full bg-accent hover:bg-green-700 text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors text-sm">
                        <i class="fas fa-credit-card"></i>
                        <span>Review Payments</span>
                    </a>
                    <a href="/" target="_blank" class="w-full bg-dark hover:bg-gray-800 text-white py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors text-sm">
                        <i class="fas fa-external-link-alt"></i>
                        <span>View Public Site</span>
                    </a>
                </div>
            </div>

            <!-- Current Site Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                <h3 class="text-lg font-bold text-blue-900 mb-3">Current Site Info</h3>
                <div class="space-y-2 text-sm text-blue-800">
                    <div class="flex justify-between">
                        <span>Site Name:</span>
                        <span class="font-semibold">{{ site_settings.site_name }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Contact:</span>
                        <span class="font-semibold">{{ site_settings.contact_phone }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Email:</span>
                        <span class="font-semibold">{{ site_settings.contact_email }}</span>
                    </div>
                    <div class="mt-3 pt-3 border-t border-blue-200">
                        <p class="text-xs">Last updated: {{ site_settings.updated_at|date:"M d, Y H:i" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmDelete(stampName) {
        return confirm(`Are you sure you want to delete the stamp "${stampName}"? This action cannot be undone.`);
    }

    // Auto-dismiss alerts after 5 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.style.transition = 'opacity 0.5s ease';
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 500);
        });
    }, 5000);
</script>

<style>
    input:focus, select:focus, textarea:focus {
        outline: none;
        ring: 2px;
        ring-color: #2563eb;
        border-color: #2563eb;
    }
    
    input[type="checkbox"] {
        width: auto;
        transform: scale(1.2);
    }
</style>
{% endblock %}